<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Client Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .chat-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .message.user {
            background-color: #007bff;
            color: white;
            text-align: right;
        }
        .message.staff {
            background-color: #28a745;
            color: white;
        }
        .message.system {
            background-color: #ffc107;
            color: black;
            font-style: italic;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .chat-input button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .buttons .primary {
            background-color: #007bff;
            color: white;
        }
        .buttons .secondary {
            background-color: #6c757d;
            color: white;
        }
        .buttons .danger {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üöÄ Chat Client Demo - Real-time Communication</h1>
    
    <div id="connection-status" class="status disconnected">
        ‚ùå Disconnected
    </div>

    <div class="buttons">
        <button id="connect-btn" class="primary">Connect to Chat</button>
        <button id="request-human-btn" class="secondary">Request Human Help</button>
        <button id="disconnect-btn" class="danger">Disconnect</button>
    </div>

    <div class="chat-container">
        <h3>üí¨ Chat Messages</h3>
        <div id="chat-messages" class="chat-messages"></div>
        
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type your message..." disabled>
            <button id="send-btn" disabled>Send</button>
        </div>
    </div>

    <div class="chat-container">
        <h3>üìä Session Info</h3>
        <p><strong>Session ID:</strong> <span id="session-id">Not connected</span></p>
        <p><strong>User:</strong> <span id="user-info">Demo User (demo@example.com)</span></p>
        <p><strong>Status:</strong> <span id="session-status">waiting</span></p>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // DOM Elements
        const statusDiv = document.getElementById('connection-status');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const connectBtn = document.getElementById('connect-btn');
        const requestHumanBtn = document.getElementById('request-human-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const sessionIdSpan = document.getElementById('session-id');
        const sessionStatusSpan = document.getElementById('session-status');

        // Socket and session state
        let socket = null;
        let sessionId = null;
        let connected = false;

        // Generate unique session ID
        function generateSessionId() {
            return 'demo-session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Add message to chat
        function addMessage(role, message, timestamp = new Date()) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div><strong>${role.toUpperCase()}:</strong> ${message}</div>
                <div style="font-size: 0.8em; opacity: 0.7;">${timestamp.toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Update connection status
        function updateStatus(isConnected) {
            connected = isConnected;
            statusDiv.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
            statusDiv.textContent = isConnected ? '‚úÖ Connected' : '‚ùå Disconnected';
            
            messageInput.disabled = !isConnected;
            sendBtn.disabled = !isConnected;
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
        }

        // Connect to chat
        function connectToChat() {
            if (socket) {
                socket.disconnect();
            }

            // Generate session ID
            sessionId = generateSessionId();
            sessionIdSpan.textContent = sessionId;
            
            // Connect to WebSocket server
            socket = io({
                query: {
                    'x-dev-bypass': 'true',
                    'session-id': sessionId
                }
            });

            // Connection events
            socket.on('connect', () => {
                console.log('‚úÖ Connected to chat server');
                updateStatus(true);
                addMessage('system', 'Connected to chat server');
                
                // Join the session room
                socket.emit('join-session', sessionId);
            });

            socket.on('disconnect', () => {
                console.log('üëã Disconnected from chat server');
                updateStatus(false);
                addMessage('system', 'Disconnected from chat server');
            });

            // Message events
            socket.on('new-message', (data) => {
                console.log('üí¨ New message received:', data);
                addMessage(data.role, data.message, new Date(data.sentAt || data.timestamp));
            });

            // Staff events
            socket.on('staff-joined', (data) => {
                console.log('üë§ Staff joined:', data);
                addMessage('system', `Staff member ${data.staffName} joined the chat`);
                sessionStatusSpan.textContent = 'assigned';
            });

            socket.on('staff-left', (data) => {
                console.log('üëã Staff left:', data);
                addMessage('system', `Staff member ${data.staffName} left the chat`);
            });

            // Error handling
            socket.on('error', (error) => {
                console.error('‚ùå Socket error:', error);
                addMessage('system', `Error: ${error.message || error}`);
            });
        }

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !socket || !connected) return;

            // Add user message to chat
            addMessage('user', message);
            
            // Send message via socket
            socket.emit('client-message', {
                sessionId: sessionId,
                message: message,
                timestamp: new Date().toISOString()
            });

            // Clear input
            messageInput.value = '';
        }

        // Request human help
        function requestHuman() {
            if (!socket || !connected) return;

            // Emit chat request for staff notification
            socket.emit('chat-request', {
                sessionId: sessionId,
                userName: 'Demo User',
                userEmail: 'demo@example.com',
                priority: 'high',
                timestamp: new Date().toISOString()
            });

            addMessage('system', 'Requesting human assistance...');
            sessionStatusSpan.textContent = 'requesting_human';
        }

        // Disconnect from chat
        function disconnectFromChat() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            sessionId = null;
            sessionIdSpan.textContent = 'Not connected';
            sessionStatusSpan.textContent = 'disconnected';
            updateStatus(false);
        }

        // Event listeners
        connectBtn.addEventListener('click', connectToChat);
        requestHumanBtn.addEventListener('click', requestHuman);
        disconnectBtn.addEventListener('click', disconnectFromChat);
        sendBtn.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize
        updateStatus(false);
        addMessage('system', 'Chat demo ready. Click "Connect to Chat" to start.');
    </script>
</body>
</html>